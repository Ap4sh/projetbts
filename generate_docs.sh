#!/bin/bash

# Titre du script
echo "====================================================="
echo "      G√©n√©rateur de documentation du projet m√©t√©o"
echo "====================================================="

# V√©rifier si Docker est en marche
echo -e "\nüîç V√©rification de Docker..."
if ! docker ps > /dev/null 2>&1; then
    echo "‚ö†Ô∏è Docker n'est pas en cours d'ex√©cution. Veuillez d√©marrer Docker."
    exit 1
fi

# Cr√©er un conteneur temporaire d√©di√© √† la documentation
echo -e "\nüê≥ Cr√©ation d'un conteneur d√©di√© √† la documentation..."
docker run --name doc-generator -d -v "$(pwd):/app" python:3.11-slim tail -f /dev/null

# Cr√©er les r√©pertoires pour la documentation
echo -e "\nüìÅ Cr√©ation de la structure de documentation..."
mkdir -p docs/source/_static
mkdir -p docs/build/html

# Installer les d√©pendances minimales
echo -e "\nüì¶ Installation des d√©pendances Python minimales..."
docker exec doc-generator pip install sphinx sphinx-rtd-theme

# Cr√©er le fichier de configuration pour Sphinx
echo -e "\n‚öôÔ∏è Configuration de Sphinx..."
cat > docs/source/conf.py << EOF
# Configuration file for the Sphinx documentation builder
import os
import sys

# Configuration g√©n√©rale
project = 'Projet M√©t√©o BTS'
copyright = '2023, √âquipe'
author = '√âquipe'

# Extensions
extensions = [
    'sphinx.ext.viewcode',
]

templates_path = ['_templates']
exclude_patterns = []

# Th√®me
html_theme = 'sphinx_rtd_theme'
html_static_path = ['_static']
html_theme_options = {
    'navigation_depth': 4,
    'titles_only': False,
    'display_version': True,
}
EOF

# Cr√©er page d'index avec sections
echo -e "\nüìù Cr√©ation de la page d'index..."
cat > docs/source/index.rst << EOF
Documentation du Projet M√©t√©o BTS
================================

Cette documentation pr√©sente le fonctionnement et l'utilisation du projet m√©t√©o BTS.

.. toctree::
   :maxdepth: 2
   :caption: Documentation utilisateur:

   installation
   usage
   api
   docker

.. toctree::
   :maxdepth: 2
   :caption: Documentation technique:

   architecture
   database
   developpement
   python_modules

Indices et tables
==================

* :ref:\`genindex\`
* :ref:\`modindex\`
* :ref:\`search\`
EOF

# Cr√©er page d'architecture
echo -e "\nüìä Cr√©ation de la page d'architecture..."
cat > docs/source/architecture.rst << EOF
Architecture du projet
=====================

Structure du projet
------------------

Le projet est organis√© comme suit:

.. code-block:: text

   $(find . -type f -not -path "*/\.*" -not -path "*/docs/*" -not -path "*/__pycache__/*" | grep -v "generate_docs.sh" | sort | head -n 20)
   [...]

Structure technique
-----------------

L'application est construite sur les technologies suivantes:

* **Backend**: Django (Python)
* **Base de donn√©es**: MySQL
* **Conteneurisation**: Docker et Docker Compose
* **Interface web**: HTML, CSS, JavaScript

Composants principaux
-------------------

* **Mod√®les Django**: D√©finition des structures de donn√©es
* **Vues Django**: Logique de traitement des requ√™tes
* **Templates**: Interface utilisateur
* **Scripts d'automatisation**: Gestion du d√©ploiement et maintenance
* **Services externes**: Int√©gration avec les API m√©t√©o
EOF

# Cr√©er page d'installation
echo -e "\nüîß Cr√©ation de la page d'installation..."
cat > docs/source/installation.rst << EOF
Installation
===========

Pr√©requis
---------

* Docker et Docker Compose
* Git

Instructions d'installation
--------------------------

1. Cloner le d√©p√¥t:

   .. code-block:: bash

      git clone <URL_DU_DEPOT>
      cd projetbts

2. Lancer l'application avec Docker:

   .. code-block:: bash

      ./start.sh

Le script start.sh effectue automatiquement les op√©rations suivantes:

- Arr√™t des conteneurs en cours d'ex√©cution
- R√©cup√©ration des changements Git
- Construction des images Docker
- D√©marrage des conteneurs
- Initialisation de la base de donn√©es
- R√©solution des conflits de migrations Django
- V√©rification des alertes m√©t√©o

Configuration
------------

Les param√®tres de configuration sont d√©finis dans le fichier \`.env\` √† la racine du projet.
EOF

# Cr√©er page d'utilisation
echo -e "\nüìñ Cr√©ation de la page d'utilisation..."
cat > docs/source/usage.rst << EOF
Utilisation
==========

Interface Web
------------

L'application web est accessible √† l'adresse http://localhost:8000 apr√®s le d√©marrage.

Fonctionnalit√©s principales
-------------------------

* Visualisation des donn√©es m√©t√©o
* Affichage des alertes m√©t√©orologiques
* Consultation de l'historique des relev√©s

API REST
-------

L'API REST est disponible aux endpoints suivants:

* \`/api/meteo/\` - Donn√©es m√©t√©o actuelles
* \`/api/alertes/\` - Alertes m√©t√©o actives

Exemples d'utilisation
-------------------

R√©cup√©ration des donn√©es m√©t√©o actuelles:

.. code-block:: bash

   curl http://localhost:8000/api/meteo/

R√©cup√©ration des alertes:

.. code-block:: bash

   curl http://localhost:8000/api/alertes/
EOF

# Cr√©er page d'API
echo -e "\nüîå G√©n√©ration de la documentation de l'API..."
cat > docs/source/api.rst << EOF
API Reference
============

Cette section contient la documentation d√©taill√©e de l'API.

Endpoints
--------

.. list-table::
   :header-rows: 1

   * - Endpoint
     - M√©thode
     - Description
   * - /api/meteo/
     - GET
     - R√©cup√®re les donn√©es m√©t√©o actuelles
   * - /api/alertes/
     - GET
     - R√©cup√®re les alertes m√©t√©o actives

Format des donn√©es
----------------

Les donn√©es sont retourn√©es au format JSON.

Exemple de r√©ponse pour /api/meteo/:

.. code-block:: json

   {
     "station": "Paris",
     "temperature": 23.5,
     "humidity": 65,
     "pressure": 1013,
     "wind_speed": 15,
     "wind_direction": "NE",
     "timestamp": "2023-06-15T14:30:00Z"
   }
EOF

# Cr√©er page de documentation de la base de donn√©es
echo -e "\nüíæ Cr√©ation de la documentation de la base de donn√©es..."
cat > docs/source/database.rst << EOF
Structure de la base de donn√©es
============================

Le projet utilise MySQL comme syst√®me de gestion de base de donn√©es.

Tables principales
-----------------

.. list-table::
   :header-rows: 1

   * - Nom de la table
     - Description
   * - stations
     - Stocke les informations sur les stations m√©t√©o
   * - releves
     - Enregistre les relev√©s m√©t√©orologiques
   * - alertes
     - Contient les alertes m√©t√©o actives

Structure d√©taill√©e
-----------------

Table \`stations\`:

.. list-table::
   :header-rows: 1

   * - Champ
     - Type
     - Description
   * - id
     - INT (PK)
     - Identifiant unique de la station
   * - nom
     - VARCHAR(100)
     - Nom de la station m√©t√©o
   * - latitude
     - DECIMAL
     - Coordonn√©e de latitude
   * - longitude
     - DECIMAL
     - Coordonn√©e de longitude
   * - altitude
     - INT
     - Altitude en m√®tres

Table \`releves\`:

.. list-table::
   :header-rows: 1

   * - Champ
     - Type
     - Description
   * - id
     - INT (PK)
     - Identifiant unique du relev√©
   * - station_id
     - INT (FK)
     - R√©f√©rence √† la station
   * - timestamp
     - DATETIME
     - Date et heure du relev√©
   * - temperature
     - DECIMAL
     - Temp√©rature en degr√©s Celsius
   * - humidite
     - INT
     - Humidit√© relative en pourcentage
   * - pression
     - INT
     - Pression atmosph√©rique en hPa
EOF

# Cr√©er page Docker
echo -e "\nüê≥ Cr√©ation de la documentation Docker..."
cat > docs/source/docker.rst << EOF
Docker et d√©ploiement
====================

Configuration Docker
-----------------

Le projet utilise Docker et Docker Compose pour faciliter le d√©ploiement.

Conteneurs:

.. list-table::
   :header-rows: 1

   * - Service
     - Image
     - Description
   * - web
     - Python 3.11
     - Application Django
   * - db
     - MySQL
     - Base de donn√©es

Fichier docker-compose.yml
------------------------

.. code-block:: yaml

   version: '3'
   
   services:
     web:
       build: .
       volumes:
         - .:/app
       ports:
         - "8000:8000"
       depends_on:
         - db
       environment:
         - DATABASE_URL=mysql://root:root_password@db:3306/weather_db
     
     db:
       image: mysql:8
       environment:
         - MYSQL_ROOT_PASSWORD=root_password
         - MYSQL_DATABASE=weather_db
       volumes:
         - db_data:/var/lib/mysql
   
   volumes:
     db_data:

Scripts de gestion
---------------

Le projet inclut plusieurs scripts pour faciliter la gestion:

* \`start.sh\` - D√©marrage complet de l'application
* \`fix_migrations.sh\` - R√©solution des conflits de migrations Django
EOF

# Cr√©er page d√©veloppement
echo -e "\nüë®‚Äçüíª Cr√©ation de la documentation de d√©veloppement..."
cat > docs/source/developpement.rst << EOF
Guide de d√©veloppement
====================

Installation pour le d√©veloppement
-------------------------------

1. Cloner le d√©p√¥t:

   .. code-block:: bash

      git clone <URL_DU_DEPOT>
      cd projetbts

2. Lancer l'environnement de d√©veloppement:

   .. code-block:: bash

      ./start.sh

Workflow de d√©veloppement
----------------------

1. Cr√©er une branche pour votre fonctionnalit√©:

   .. code-block:: bash

      git checkout -b feature/nom-de-la-fonctionnalite

2. Impl√©menter les changements n√©cessaires

3. Tester localement:

   .. code-block:: bash

      docker-compose exec web python manage.py test

4. Soumettre une pull request vers la branche principale

Guidelines de code
---------------

* Suivre les conventions PEP 8 pour le code Python
* Documenter les fonctions et classes avec des docstrings (format Google ou NumPy)
* √âcrire des tests unitaires pour les nouvelles fonctionnalit√©s

Format des docstrings
-----------------

Utilisez le format Google pour les docstrings:

.. code-block:: python

   def ma_fonction(param1, param2):
       """Description de la fonction.
       
       Args:
           param1 (type): Description du param√®tre 1.
           param2 (type): Description du param√®tre 2.
           
       Returns:
           type: Description de la valeur de retour.
           
       Raises:
           Exception: Description des exceptions possibles.
       """
       # Code de la fonction
EOF

# Cr√©er un script Python pour extraire manuellement les docstrings
echo -e "\nüîç Cr√©ation d'un script pour extraire les docstrings..."
cat > extract_manual.py << EOF
#!/usr/bin/env python
import os
import re
from pathlib import Path

def extract_class_docstrings(content):
    """Extrait les docstrings des classes √† partir du contenu."""
    class_pattern = r'class\s+(\w+).*?:\s*(\'\'\'|\"\"\")(.+?)(\'\'\'|\"\"\")'
    matches = re.finditer(class_pattern, content, re.DOTALL)
    
    results = {}
    for match in matches:
        class_name = match.group(1)
        docstring = match.group(3).strip()
        results[class_name] = docstring
    
    return results

def extract_function_docstrings(content):
    """Extrait les docstrings des fonctions √† partir du contenu."""
    function_pattern = r'def\s+(\w+)\s*\(.*?\).*?:\s*(\'\'\'|\"\"\")(.+?)(\'\'\'|\"\"\")'
    matches = re.finditer(function_pattern, content, re.DOTALL)
    
    results = {}
    for match in matches:
        function_name = match.group(1)
        docstring = match.group(3).strip()
        results[function_name] = docstring
    
    return results

def main():
    # Contenu du fichier weather_api.py
    weather_api_content = """${cat /app/weather/services/weather_api.py 2>/dev/null || echo "Fichier non trouv√©"}"""
    
    classes = extract_class_docstrings(weather_api_content)
    functions = extract_function_docstrings(weather_api_content)
    
    output_dir = "/app/docs/source"
    os.makedirs(output_dir, exist_ok=True)
    
    with open(f"{output_dir}/python_modules.rst", "w") as f:
        f.write("Modules Python\n")
        f.write("=============\n\n")
        
        f.write("Services m√©t√©o\n")
        f.write("-------------\n\n")
        
        # Classes du module weather_api
        for class_name, docstring in classes.items():
            f.write(f"{class_name}\n")
            f.write("~" * len(class_name) + "\n\n")
            f.write(f"{docstring}\n\n")
            
            f.write("M√©thodes:\n\n")
            
            # Trouver les m√©thodes de cette classe
            method_pattern = fr'def\s+(\w+)\s*\(self(?:,\s*.*?)?\).*?:\s*(\'\'\'|\"\"\")(.+?)(\'\'\'|\"\"\")'
            class_content = re.search(fr'class\s+{class_name}.*?:(.*?)(?:class|\Z)', weather_api_content, re.DOTALL)
            
            if class_content:
                methods = re.finditer(method_pattern, class_content.group(1), re.DOTALL)
                for method in methods:
                    method_name = method.group(1)
                    method_doc = method.group(3).strip()
                    
                    f.write(f"**{method_name}**\n\n")
                    f.write(f"{method_doc}\n\n")
        
        # Fonctions du module au niveau sup√©rieur
        f.write("Fonctions utilitaires\n")
        f.write("-------------------\n\n")
        
        for func_name, docstring in functions.items():
            if not func_name.startswith('_'):  # Ignorer les fonctions priv√©es
                f.write(f"**{func_name}**\n\n")
                f.write(f"{docstring}\n\n")

if __name__ == "__main__":
    main()
EOF

# Ex√©cuter le script d'extraction
echo -e "\nüîç Extraction manuelle des docstrings..."
docker exec -T doc-generator bash -c "cat > /app/extract_manual.py" < extract_manual.py
docker exec doc-generator python /app/extract_manual.py

# G√©n√©rer la documentation avec Sphinx
echo -e "\nüöÄ G√©n√©ration de la documentation avec Sphinx..."
docker exec -w /app/docs/source doc-generator sphinx-build -b html . ../build/html

# Nettoyer
echo -e "\nüßπ Nettoyage..."
docker stop doc-generator
docker rm doc-generator
rm extract_manual.py

# Finalisation
echo -e "\n‚úÖ Documentation g√©n√©r√©e avec succ√®s !"
echo "La documentation HTML est disponible dans le r√©pertoire: docs/build/html/"
echo "Ouvrez le fichier index.html dans votre navigateur pour consulter la documentation."
echo "====================================================="

# Proposer d'ouvrir la documentation
read -p "Voulez-vous ouvrir la documentation dans votre navigateur ? (o/n) : " ouvrir_doc
if [[ "$ouvrir_doc" == "o" || "$ouvrir_doc" == "O" ]]; then
    if command -v xdg-open > /dev/null; then
        xdg-open docs/build/html/index.html
    elif command -v open > /dev/null; then
        open docs/build/html/index.html
    else
        echo "Impossible d'ouvrir automatiquement. Veuillez ouvrir manuellement le fichier:"
        echo "docs/build/html/index.html"
    fi
fi 