{% extends 'base.html' %}

{% block title %}Météo {{ city }} - Détails{% endblock title %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    /* Styles pour corriger l'affichage des contrôles de couches */
    .leaflet-control-layers {
        max-height: 300px !important;
        overflow-y: auto !important;
        padding: 6px 10px 6px 6px !important;
        background: white !important;
        border-radius: 0.5rem !important;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
        position: absolute !important;
        top: 10px !important;
        right: 10px !important;
        z-index: 1000 !important;
    }
    
    .leaflet-control-layers-expanded {
        padding: 6px 10px 6px 6px !important;
        background: white !important;
        border-radius: 0.5rem !important;
        max-height: 300px !important;
        overflow-y: auto !important;
    }
    
    .leaflet-control-layers-selector {
        margin-top: 2px !important;
    }
    
    .leaflet-control-layers-list {
        margin-bottom: 0 !important;
        max-height: 250px !important;
        overflow-y: auto !important;
    }
    
    .leaflet-control-layers-overlays {
        max-height: 200px !important;
        overflow-y: auto !important;
    }
    
    /* Styles pour les légendes OWM */
    .owm-legend {
        max-height: 300px;
        overflow-y: auto;
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
    }
</style>
{% endblock extra_css %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- En-tête avec le nom de la ville et les données principales -->
    <div class="flex flex-col md:flex-row items-center justify-between mb-8 bg-base-200 p-6 rounded-box shadow-md">
        <div class="flex items-center gap-4">
            <div class="weather-icon">
                <img src="https://openweathermap.org/img/wn/{{ current_weather.weather.icon }}@4x.png" 
                     alt="{{ current_weather.weather.description }}" 
                     class="w-24 h-24" />
            </div>
            <div>
                <h1 class="text-3xl font-bold">{{ city }}</h1>
                <p class="text-xl">{{ current_weather.weather.description|capfirst }}</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-4xl font-bold">{{ current_weather.main.temp|floatformat:0 }}°C</span>
                    <span class="text-sm opacity-70">
                        Ressenti: {{ current_weather.main.feels_like|floatformat:0 }}°C
                    </span>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-4 md:mt-0">
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Humidité</div>
                <div class="text-xl font-semibold">{{ current_weather.main.humidity }}%</div>
            </div>
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Vent</div>
                <div class="text-xl font-semibold">{{ current_weather.wind.speed }} km/h</div>
            </div>
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Pression</div>
                <div class="text-xl font-semibold">{{ current_weather.main.pressure }} hPa</div>
            </div>
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Visibilité</div>
                <div class="text-xl font-semibold">{{ current_weather.visibility|floatformat:0 }} m</div>
            </div>
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Lever du soleil</div>
                <div class="text-xl font-semibold">{{ current_weather.sys.sunrise|date:"H:i" }}</div>
            </div>
            <div class="stat-box p-3 bg-base-100 rounded-box">
                <div class="text-sm opacity-70">Coucher du soleil</div>
                <div class="text-xl font-semibold">{{ current_weather.sys.sunset|date:"H:i" }}</div>
            </div>
        </div>
    </div>
    
    <!-- Prévisions pour les prochains jours -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Prévisions sur 5 jours</h2>
        {% include 'weather/partials/forecast_table.html' with forecast=forecast %}
    </div>
    
    <!-- Alertes météo pour cette région -->
    <div class="mb-8">
        <h2 class="text-2xl font-bold mb-4">Alertes météo</h2>
        
        {% if api_alerts or db_alerts %}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for alert in api_alerts %}
                <div class="alert {% if alert.severity == 'red' %}alert-error{% elif alert.severity == 'orange' %}alert-warning{% else %}alert-info{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                        <h3 class="font-bold">{{ alert.event }}</h3>
                        <div class="text-sm">{{ alert.start|date:"j F H:i" }} - {{ alert.end|date:"j F H:i" }}</div>
                        <div class="text-xs mt-1">{{ alert.description }}</div>
                    </div>
                </div>
                {% endfor %}
                
                {% for alert in db_alerts %}
                <div class="alert {% if alert.severity == 'red' %}alert-error{% elif alert.severity == 'orange' %}alert-warning{% else %}alert-info{% endif %}">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    <div>
                        <h3 class="font-bold">Alerte {{ alert.fk_type.label }}</h3>
                        <div class="text-sm">{{ alert.region }} - {{ alert.date_alert|date:"j F Y" }}</div>
                        <div class="text-xs mt-1">{{ alert.description }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span>Aucune alerte météo en cours pour cette région.</span>
            </div>
        {% endif %}
    </div>
    
    <!-- Carte de localisation -->
    <div>
        <h2 class="text-2xl font-bold mb-4">Localisation</h2>
        <div class="h-[400px] bg-base-200 rounded-box">
            {% if current_weather.coordinates %}
            <div id="city-map" class="w-full h-full rounded-box"></div>
            {% else %}
            <div class="flex items-center justify-center h-full">
                <p>Carte non disponible</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% if current_weather.coordinates %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Coordonnées de la ville (converties en variables JavaScript)
        var lat = parseFloat("{{ current_weather.coordinates.lat|floatformat:6 }}".replace(",", "."));
        var lon = parseFloat("{{ current_weather.coordinates.lon|floatformat:6 }}".replace(",", "."));
        var cityName = "{{ city }}";
        
        // Initialiser la carte
        var map = L.map('city-map').setView([lat, lon], 12);
        
        // Ajouter la couche de base OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        // Ajouter un marqueur pour la ville
        var marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup("<b>" + cityName + "</b><br>{{ current_weather.weather.description|capfirst }}").openPopup();
        
        // Clé API OpenWeatherMap
        var apiKey = 'a6b2d8524308570bedd6e593c1f5a8b6';
        
        // Créer les couches météo manuellement
        var precipitationLayer = L.tileLayer('https://tile.openweathermap.org/map/precipitation_new/{z}/{x}/{y}.png?appid=' + apiKey, {
            attribution: 'OpenWeatherMap',
            maxZoom: 19,
            opacity: 0.6
        });
        
        var tempLayer = L.tileLayer('https://tile.openweathermap.org/map/temp_new/{z}/{x}/{y}.png?appid=' + apiKey, {
            attribution: 'OpenWeatherMap',
            maxZoom: 19,
            opacity: 0.6
        });
        
        var windLayer = L.tileLayer('https://tile.openweathermap.org/map/wind_new/{z}/{x}/{y}.png?appid=' + apiKey, {
            attribution: 'OpenWeatherMap',
            maxZoom: 19,
            opacity: 0.6
        });
        
        var pressureLayer = L.tileLayer('https://tile.openweathermap.org/map/pressure_new/{z}/{x}/{y}.png?appid=' + apiKey, {
            attribution: 'OpenWeatherMap',
            maxZoom: 19,
            opacity: 0.6
        });
        
        var cloudsLayer = L.tileLayer('https://tile.openweathermap.org/map/clouds_new/{z}/{x}/{y}.png?appid=' + apiKey, {
            attribution: 'OpenWeatherMap',
            maxZoom: 19,
            opacity: 0.6
        });
        
        // Ajouter le contrôle de couches
        var baseMaps = {
            "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            })
        };
        
        var overlayMaps = {
            "Précipitations": precipitationLayer,
            "Température": tempLayer,
            "Vent": windLayer,
            "Pression": pressureLayer,
            "Nuages": cloudsLayer
        };
        
        L.control.layers(baseMaps, overlayMaps, {
            collapsed: false
        }).addTo(map);
        
        // Ajouter la couche de précipitations par défaut
        precipitationLayer.addTo(map);
        
        // Forcer une mise à jour de la taille après un court délai
        setTimeout(function() {
            map.invalidateSize();
        }, 500);
        
        // Ajouter un gestionnaire de redimensionnement
        window.addEventListener('resize', function() {
            map.invalidateSize();
        });
    });
</script>
{% endif %}
{% endblock content %}

{% block extra_js %}
{% endblock extra_js %} 